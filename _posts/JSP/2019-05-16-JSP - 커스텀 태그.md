---
title:  "JSP/Servlet - 커스텀 태그 !"

read_time: false
share: false
author_profile: false
classes: wide

categories:
  - JSP

tags:
  - JSP
  - servelt

toc: true

---

## 커스텀 태그

개발자가 필요에 의해 새로운 태그를 만들어 사용할 수 있도록 JSP가 지원한다.  

스크립트 요소가 많이 사용될수록 복잡해지고 유지보수가 힘들어지기 때문에 커스텀 태그가 사용된다.  

JSTL 코어태그의 시작도 자주 사용되는 커스텀 태그들이 표준화 된 것이다.  

JSP가 지원하는 커스텀 태그에 대해 알아보자.  


커스텀 태그를 만드는 방법은 아래 3가지  

1. JSP 1.2 스타일로 구현된 커스텀 태그
2. JSP 2.0 또는 그 이상 버전의 **SimpleTag**를 사용한 커스텀 태그
3. JSP 2.0 또는 그 이상 버전의 **태그파일**을 사용한 커스텀 태그

우리는 3번째 방법인 태그파일을 사용한 커스텀 태그를 사용한다.  


### 커스텀 태그 환경설정  

태그파일은 `/WEB-INF/tags`폴더나 그 하위폴더에 추가시켜야 인식한다.  
확장자는 `.tag`, `.tagx` 확장자명을 사용해야 한다.  

그리고 만들어진 커스텀 태그(태그파일)를 사용하고 싶다면 아래와 같이 `taglib` 디렉티브를 추가시켜야 한다.

`<%@ taglib prefix="tf" tagdir="/WEB-INF/tags/util" %>`  
(접두사는 원하는대로 설정 가능)  

간단한 날짜를 출력하는 커스텀 태그파일을 만들어보자.  

먼저 커스텀 태그 없이 날짜를 출력하려면 아래와 같은 코딩이 필요하다.  
```html
<%@page import="java.util.Calendar"%>
<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%
Calendar cal = Calendar.getInstance();
int year = cal.get(Calendar.YEAR);
int month = cal.get(Calendar.MONTH) + 1;
int day = cal.get(Calendar.DAY_OF_MONTH);
%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>JSP / Servelet Class - kouzie(2019. 5. 16.-오전 10:03:09)</title>
</head>
<body>
<%= year %>년 <%= month %>월 <%= day %>일
</body>
</html>
```
출력값
```
2019년 5월 16일
```

날짜하나 찍기 위해 `Calender`선언 및 각종 변수초기화, `body`태그안에 출력구문을 사용하였다.  

만약 많은 jsp파일에서 날짜를 출력해야 한다면 

날짜 출력하는 커스텀 태그를 하나 만들어보자.  

```html
<%@ tag import="java.util.Calendar"%>
<%@ tag body-content="empty" language="java" pageEncoding="UTF-8"%>

<%
Calendar cal = Calendar.getInstance();
int year = cal.get(Calendar.YEAR);
int month = cal.get(Calendar.MONTH) + 1;
int day = cal.get(Calendar.DAY_OF_MONTH);
%>
<%= year %>년 <%= month %>월 <%= day %>일
```

시작태그와 닫기태그 사이에 값이 아무것도 안들어갈 경우 `body-content`는 `empty`로 설정한다. 


```html
<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="tf" tagdir="/WEB-INF/tags/util" %>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>JSP / Servelet Class - kouzie(2019. 5. 16.-오전 10:03:09)</title>
</head>
<body>
<tf:now/>
</body>
</html>
```
출력값
```
2019년 5월 16일
```


### 태그파일에서 사용 가능한 기본 객체

`jspContext` : JSP 페이지의 `pageContext`기본객체가 제공하는 `setAttribute()`, `getAttribute()`메서드를 사용 가능.

`request` : JSP 페이지의 `request` 기본객체와 똑같다.

`response` : JSP 페이지의 `response` 기본객체와 똑같다.

`session` : JSP 페이지의 `session` 기본객체와 똑같다.

`application` : JSP 페이지의 `application` 기본객체와 똑같다.

`out` : JSP 페이지의 `out` 기본객체와 똑같다.

태그파일에서도 스크립트릿과 jsp에서 제공하는 기본객체들을 사용가능하다.  

### 태그파이렝서 사용가능한 디렉티브

**디렉티브**|**설명**
:-----:|:-----
`tag`| JSP 페이지의 **page 디렉티브와 동일하다.** page 디렉티브가 JSP 페이지에 대한 설정정보 들을 명시하는 것처럼 **tag 디렉티브는 태그 파일의 정보를 명시한다** 
`taglib`| 태그 파일에서 사용할 태그 라이브러리를 명시할 때 사용한다(코어태그, 함수태그, 국제화태그). 문법은 JSP 페이지와 완전히 동일하다 
`include`| JSP 페이지와 마찬가지로 **태그 파일에 특정한 파일을 포함시킬때** 사용한다. 단, 태그 파일에 포함되는 파일은 태그 파일에 알맞은 문법으로 작성되어야한다. 
`attribute`| 태그 파일이 커스텀 태그로 사용될 때 입력받을 속성을 명시한다
`variable`| EL 변수로 사용될 변수에 대한 정보를 지정한다



**속성**|**설명**
:-----:|:-----
`display-name`| 태그 파일을 도구에서 보여줄때 사용될 이름을 지정한다.  기본값은 확장자 ".tag"를 제외한 태그 파일의 나머지 이름이다 
`body-content`| 몸체 내용의 종류를 입력한다. empty, tagdependent, scriptless의  세가지 값중 한가지를 사용할수 있다.  기본값은 scriptless 이다 
`dynamic-attributes`| 동적 속성을 사용할때, 속성의 <이름, 값>을 저장하는 Map 객체를 page범위  의 속성에 저장할 때 사용할 이름을 명시한다. (태그 파일은 JSp 페이지의  pageContext 기본 객체와 비슷하게 jspContext 기본 객체를 지원하고  있으며, 이 jspContext 기본 객체에 저장될 속성명을 지정한다)  EL에서 변수 이름으로 사용할수 있다. 
`description`| 태그에 대한 설명을 입력한다
`import`| page 디렉티브의 import 속성과 동일한다
`pageEncoding`| page 디렉티브의 pageEncoding 속성과 동일하다
`isELIgnore`| page 디렉티브의 isELIgnore 속성과 동일하다
`deferredSytaxAllowedAsLiteral`|page 디렉티브의 deferredSyntaxAllowedAsLiteral  속성과 동일하다 
`trimDirectiveWhitespaces`| page 디렉티브의 trimDirectiveWhitespaces 속성과 동일하다

### 태그 속성값 설정

코어태그에 여러가지 속성들이 들어갔었따. begin, end, items, varStatus, value 등등

우리가 만든 커스텀태그에도 속성 설정이 가능하다.  

**속성 **|**설명 **
:-----:|:-----
`description`| 속성에 대한 설명 (선택)
`name`| 속성의 이름. 태그 파일 내에서 스크립트 변수나 EL 변수의 이름으로 사용된다. 각각의 attribute 디렉티브는 name 속성의 값이 서로 달라야한다.  name 속성의 값이 tag 디렉티브의 `dynamic-attributes` 속성의 값과 같거나 또는  variable 디렉티브의 name-given 속성의 값과 같으면 에러가 발생한다 (필수) 
`required`| 속성의 필수 여부를 지정한다. 필수일 경우 true, 아닌 경우 false를 값으로 지정한다  기본값은 false 
`rtexprvalue`| 속성 값으로 표현식을 사용할 수 있는지의 여부를 지정한다. 기본값은 true
`type`| 속성 값의 타입을 명시한다. int, long, char 등의 기본 데이터 타입은 명시할 수 없으며  대신 java.lang.Interger와 같은 래퍼 타입을 사용한다.  기본값은 java.lang.String 
`fragment`| `<jsp:attribute>` 액션 태그로 속성값을 전달할 때 이 값을 true로 지정한다  fragment 속성의 값을 true로 지정하면 rtexprvalue 속성은 자동으로 false로 되고 type 속성의 값은 `java.servlet.jsp.tagext.JspFrgment`가 된다. 


### 태그파일에 동적으로 속성 전달



### 몸체 내용 전달

2가지 방법이 있다.  
시작태그와 닫기태그 사이에 값을 넣기
`<jsp:body>`액션 태그 사용하기  

EL태그를 처리한 몸체 내용 사용하기 


1. body-content="scriptless"로 두어야 한다.  
2. jsp:doBody 액션태그를 이용해서 몸체내용을 출력, EL변수로 저장한다.  


## 계층형 게시판

답글이 달릴수 있는 게시글을 구축해보자.  

기존 게시글에서 칼럼이 몇개 추가될뿐 크게 다르지 않다.

### 계층형 게시판을 구현하는 로직 1


그룹넘버, 그룹순번, 그룹깊이    
3개의 칼럼을 기존 게시글에서 추가해야 한다.  

먼저 그룹넘버는 답글이 아닌 새글이라면 게시글의 기본키인 글 번호와 같도록 설정한다.  

그리고 새글의 경우 그룹순번과 그룹깊이는 0으로 설정한다.  

```
글번호	  작성자	    제목	  그룹	  그룹순번	  그룹깊이
1	  홍길동	  첫번째글	  1	  0	          0
2	  둘리	  두번째글	  1	  0	          0
...
```

여기서 첫번째 게시글에 답글을 달 경우 그룹은 부모의 그룹번호를 가지고 가고  
그룹 순번과 그룹 깊이는 부모의 값에서 +1 한 값을 가진다.
```
글번호	  작성자	    제목	  그룹	  그룹순번	  그룹깊이
1	  홍길동	  첫번째글	  1	  0	          0
2	  둘리	  두번째글	  2	  0	          0
3	  또치	  첫글의 답글	  1	  1	          1
...
```
실제 DB에 위와같은 형식으로 들어간다.

답글의 답글 역시 마찬가지로 부모의 답글에서 그룹순번과 그룹깊이를 +1한 값을 가진다.  
```
글번호	  작성자	    제목	  그룹	  그룹순번	  그룹깊이
1	  홍길동	  첫번째글	  1	  0	          0
2	  둘리	  두번째글	  2	  0	          0
3	  또치	  첫글의 답글	  1	  1	          1
4	  마이클	  답글의 답글	  1	  2	          2
...
```

그리고 이를 그룹, 그룹순번, 그룹깊이를 모두 내림차순(desc)하여 정렬하면 다음과 같이 줄력된다.
```
글번호	  작성자	    제목	  그룹	  그룹순번	  그룹깊이
1	  고길동	  첫번째글	  1	  0	          0
3	  또치	  첫글의 답글	  1	  1	          1
4	  마이클	  답글의 답글	  1	  2	          2
2	  둘리	  두번째글	  2	  0	          0
```
깊이에 따라 들여쓰기 작업만 해주면 계층형 게시판 구실을 할 수 있다.  

주의할점은 여기서 또 첫번째 글에 다시 답글을 달 경우인데

그럼 아래와 같은 값의 답글이 생성된다.  
```
글번호	  작성자	    제목	  그룹	  그룹순번	  그룹깊이
5	  도우너	  첫글 답글2	  1	  1	          1
```
이글을 또치의 답글과 그룹, 그룹순번, 그룹깊이가  완벽히 일치하기 때문에 내침차순 정렬해도 의미가 없다.  

따라서 기존에 자신의 같은 그룹의 **모든 답글의 그룹순번을 모두 1씩 더해주어야 한다.**  
```
글번호	  작성자	    제목	  그룹	  그룹순번	  그룹깊이
1	  고길동	    첫번째글	  1	  0	          0
5	  도우너	    첫글 답글2	  1	  1	          1
3	  또치	    첫글의 답글	  1	  2	          1
4	  마이클	    답글의 답글	  1	  3	          2
2	  둘리	    두번째글	  2	  0	          0
```
그럼 위와 같이 정렬되는 것을 알 수 있다.  

그룹 깊이에 따라 들여쓰기만 하면 계층형 게시판 완성이다.  

### 계층형 게시판을 구현하는 로직 2

2번째 방법은 thread칼럼, 그룹깊이 칼럼을 추가하여 계층형 게시판을 구현하는 방법이다.  

일단 칼럼을 2개만 추가하면 된다는 것이 매력적인 방법이다.  

thread칼럼은 새글의 경우 글번호 * 1000을 한 값이다.  

```
글번호	  작성자	    제목	 thread	  그룹깊이
1	  홍길동	    첫번째글	  1000    1
2	  둘리	    두번째글	  2000	  1
...
```


여기서 첫번째 게시글에 답글은 단다면  
thread는 부모글의 `thread - 1`, 그룹깊이는 부모글의 `depth + 1`이 된다.   
```
글번호	  작성자	    제목	 thread	  그룹깊이
1	  홍길동	    첫번째글	  1000    1
2	  둘리	    두번째글	  2000	  1
3	  마이클	    첫글 답글	  1999	  2
...
```

만약 답글에 대한 답글을 달 때 에도 `thread`는 부모글의 `thread - 1`, 그룹깊이는 부모글의 `depth + 1`이 된다. 
  
```
글번호	  작성자	    제목	 thread	  그룹깊이
1	  홍길동	    첫번째글	  1000    1
2	  둘리	    두번째글	  2000	  1
3	  마이클	    첫글 답글	  1999	  2 
4	  또치	    답글의 답글	  1998	  3 
...
```

정렬은 thread는 올림차순, 그룹깊이를 내림차순으로 정렬하면 된다.  
```
글번호	  작성자	    제목	 thread	  그룹깊이
1	  홍길동	    첫번째글	  1000    1
3	  마이클	    첫글 답글	  999	  2 
4	  또치	    답글의 답글	  998	  3 
2	  둘리	    두번째글	  2000	  1
...
```
정렬되면 위와같이 출력

계층형 구현하는 로직 1과 마찬가지로 위 상황에서 첫번째 글에 또 답글이 달리게 된다면 다음 데이터가 추가될 것이다.  
```
글번호	  작성자	    제목	  thread  그룹깊이
5	  둘리	    첫글 답글2	  999	  2 
```

마이클의 답글의 thread값과 똑같아 지기 때문에 로직2도 로직1과 마찬가지로 `0 ~ 999`까지의 thread에 모든 글의 thread를 -1 해줘야 한다.  

이 방법은 thread칼럼 하나로 그룹번호와 그룹순번 칼럼을 대신하는 효과를 가지고 있다.   
대신 답글을 1000개이상 못단다는 단점이 있다.  



### DB생성
```sql
create table replyboard16
(
   num number not null primary key
  ,writer varchar2(12) not null
  ,email  varchar2(30) not null
  ,subject varchar2(50) not null
  ,pass varchar2(10) not null
  ,readcount number(5,0) default 0 not null
  ,regdate date default sysdate not null
  ,content clob not null
  ,ip varchar2(20) not null
  ,ref number(5,0) default 0 not null
  ,step  number(3,0) default 0 not null
  ,depth number(3,0) default 0 not null
);


create sequence seq_replyboard16
start with 1
increment by 1
nomaxvalue
nocache
nocycle;
```
